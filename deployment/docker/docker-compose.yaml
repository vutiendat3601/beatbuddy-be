version: '3.7'
name: beatbuddy
services:
  # #: API
  apiredis:
    image: redis:7.0-bookworm
    hostname: apiredis
    ports:
      - 6379:6379
    environment:
      - REDIS_PASSWORD=bbapiredis
    networks:
      - beatbuddy
  apidb:
    image: postgres:16.1-bookworm
    hostname: apidb
    environment:
      - POSTGRES_DB=bbapidb
      - POSTGRES_USER=bbapidb
      - POSTGRES_PASSWORD=bbapidb
      - PGPASSWORD=bbapidb
    ports:
      - 5432:5432
    volumes:
      - bbapidb:/var/lib/postgresql/data/
      - ./api/db/initdb.d/:/docker-entrypoint-initdb.d/
      - ./api/db/backup/:/backup/
      - ./api/db/backup.sh:/backup.sh
    networks:
      - beatbuddy
  api:
    image: vutiendat3601/bbapi:1.0.0
    hostname: api
    environment:
      - DB_URL=jdbc:postgresql://apidb:5432/bbapidb
      - DB_USER=bbapidb
      - DB_PASS=bbapidb
      - FLYWAY_BASELINE_VERSION=1
      - JWKS_URI=https://bbauth.datvu.tech/realms/beatbuddy/protocol/openid-connect/certs
      - REDIS_HOST=apiredis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=bbapiredis
      - PORT=8080
      - BBAPI_CLIENT_ID=bbapi
      - BBAPI_CLIENT_SECRET=OlgAtZaj5SRia4YWBvKPok07rfGUKSoP
      - BBAPI_TOKEN_URI=https://bbauth.datvu.tech/realms/beatbuddy/protocol/openid-connect/token
      - BB_STORAGE_URL=http://bbstorage.datvu.tech
    ports:
      - 8080:8080
    volumes:
      - bbapi:/root/beatbuddy
    depends_on:
      - apiredis
      - apidb
    networks:
      - beatbuddy
  # API

  # ## Storage
  storage:
    image: vutiendat3601/bbstorage:1.0.0
    hostname: storage
    environment:
      - JWKS_URI=https://bbauth.datvu.tech/realms/beatbuddy/protocol/openid-connect/certs
      - PORT=8081
    ports:
      - 8081
    volumes:
      - bbstorage:/root/beatbuddy
    networks:
      - beatbuddy

  # #: Auth
  authdb:
    image: postgres:16.1-bookworm
    hostname: authdb
    environment:
      - POSTGRES_USER=bbauthdb
      - POSTGRES_DB=bbauthdb
      - POSTGRES_PASSWORD=bbauthdb
      - PGPASSWORD=bbauthdb
    volumes:
      - bbauthdb:/var/lib/postgresql/data/
      - ./auth/db/initdb.d/:/docker-entrypoint-initdb.d/
      - ./auth/db/backup/:/backup/
      - ./auth/db/backup.sh:/backup.sh
    networks:
      - beatbuddy
  auth:
    build: ./auth/
    # image: vutiendat3601/beatbuddyauth:1.0.0
    hostname: auth
    environment:
      - KC_DB_URL=jdbc:postgresql://authdb:5432/bbauthdb
      - KC_DB_USERNAME=bbauthdb
      - KC_DB_PASSWORD=bbauthdb
      - KC_HOSTNAME_URL=http://beatbuddyauth.datvu.tech
      - KC_HOSTNAME_ADMIN_URL=http://beatbuddyauth.datvu.tech
      - KC_HTTP_PORT=8090
      # - KC_PROXY=reencrypt
      - hostname-strict=false
      - KC_PROXY=edge
    depends_on:
      - authdb
    networks:
      - beatbuddy
    ports:
      - 8090
    command: ['start']
  # # Auth

  # ## Proxy
  proxy:
    image: nginx:mainline-bookworm
    hostname: proxy
    volumes:
      - ./proxy/nginx.conf:/etc/nginx/conf.d/default.conf
      - bbstorage:/usr/share/nginx/static/
    ports:
      - '80:80'
    depends_on:
      - auth
      - api
      - storage
    networks:
      - beatbuddy
    healthcheck:
      test: curl http://api:8080 && curl http://storage:8081 && curl http://auth:8090
      interval: 30s
      timeout: 30s
      retries: 3
      start_period: 30s
    restart: on-failure
volumes:
  bbapidb:
    name: bbapidb
    driver: local
  bbapi:
    name: bbapi
    driver: local
  bbauthdb:
    name: bbauthdb
    driver: local
  bbstorage:
    name: bbstorage
    driver: local
networks:
  beatbuddy:
    name: beatbuddy
    driver: bridge
